#+TITLE:      collections
#+AUTHOR:     rgb-24bit
#+EMAIL:      rgb-24bit@foxmail.com

* Table of Contents                                       :TOC_4_gh:noexport:
- [[#import][import]]
- [[#userdict][UserDict]]
- [[#相关链接][相关链接]]

* import
  #+BEGIN_SRC python
    ...
    # https://docs.python.org/3/library/operator.html#operator.itemgetter
    # def itemgetter(*items):
    #     if len(items) == 1:
    #         item = items[0]
    #         def g(obj):
    #             return obj[item]
    #     else:
    #         def g(obj):
    #             return tuple(obj[item] for item in items)
    #     return g
    from operator import itemgetter as _itemgetter, eq as _eq

    ...

    # https://docs.python.org/3.7/library/keyword.html
    # 可以用于判断一个字符串是否为关键字
    from keyword import iskeyword as _iskeyword

    ...

    # https://docs.python.org/3/library/reprlib.html#module-reprlib
    # repr() 的替代实现
    from reprlib import recursive_repr as _recursive_repr

    ...
  #+END_SRC

  Python 各种库是真滴多......

* UserDict
  UserDict 和默认的 Dict 之间还是存在一些区别的，之前一直没什么感觉，直到这一段代码的出现：
  #+BEGIN_SRC python
    class NestedDict(dict):
        """Automated nested dictionary.

        >>> nd = NestedDict()
        >>> nd['a']['b']['c'] = 1
        >>> nd
        {'a': {'b': {'c': 1}}}
        """
        def __getitem__(self, key):
            return self.setdefault(key, self.__class__())
  #+END_SRC

  上面这段代码中，如果继承的是 UserDict, 就会陷入无限递归。
  
  + [[https://github.com/python/cpython/blob/master/Lib/collections/__init__.py#L999][class UserDict(_collections_abc.MutableMapping)]]

  说起来，UserDict 的本身的源码还是很简单的，上面问题的来源还是需要看一下父类的代码。

  哈，问题就在这里：
  #+BEGIN_SRC python
    def setdefault(self, key, default=None):
        'D.setdefault(k[,d]) -> D.get(k,d), also set D[k]=d if k not in D'
        try:
            return self[key]
        except KeyError:
            self[key] = default
        return default
  #+END_SRC

  感觉 UserDict 可以覆盖 setdefault 方法和 get 方法：
  #+BEGIN_SRC python
    def get(self, key, default=None):
        'D.get(k[,d]) -> D[k] if k in D, else d.  d defaults to None.'
        try:
            return self[key]
        except KeyError:
            return default

    # ------------------------------------------------------------------------------

    def setdefault(self, key, default=None):
        return self.data.setdefault(key, default)

    def get(self, key, default=None):
        return self.data.get(key, default)
  #+END_SRC

  或者，编写 UserDict 的子类的时候注意......
  #+BEGIN_SRC python
    class NestedDict(UserDict):
        def __getitem__(self, key):
            return self.data.setdefault(key, self.__class__())
  #+END_SRC

  好吧，官方文档还真有提示： [[https://docs.python.org/3/library/collections.html#collections.UserDict][class collections.UserDict({initialdata})]]

* 相关链接
  + [[https://docs.python.org/3/library/collections.html][collections — Container datatypes]]
  + [[https://github.com/python/cpython/blob/master/Lib/collections/__init__.py][collections - source code]]
  + [[https://github.com/python/cpython/blob/master/Lib/_collections_abc.py][_collections_abc source code]]
  + [[https://github.com/python/cpython/blob/master/Modules/_collectionsmodule.c][_collectionsmodule C source code]]
